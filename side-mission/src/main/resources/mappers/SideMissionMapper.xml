<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bsm.oa.sm.dao.SideMissionRepository">

  <resultMap id="SideMissionTypeMap" type="com.bsm.oa.sm.model.SideMissionType">
    <result property="typeId" column="sm_type_id" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
    <result property="equation" column="equation" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
    <result property="descriptionDocumentUrl" column="doc_url" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
    <result property="dictionaryName" column="dictionary_name" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
    <collection property="performParams" ofType="com.bsm.oa.sm.model.PerformParam">
      <result property="symbol" column="equation_symbol" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
      <result property="hint" column="param_hint" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
      <result property="type" column="perform_param_type"/>
      <result property="toJudgeBy" column="to_judge_by"/>
      <result property="availableValuesSource" column="available_values_source"/>
    </collection>
    <collection property="proofRequirements" ofType="com.bsm.oa.sm.model.ProofRequirement">
      <result property="type" column="proof_req_type"/>
      <result property="hint" column="proof_hint" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
      <result property="exampleUrl" column="proof_example_url" typeHandler="com.bsm.oa.common.mapper.StringVOHandler"/>
    </collection>
  </resultMap>

  <sql id="sideMissionTypeColumns">
    t.sm_type_id,
    t.description_document_url as doc_url,
    t.equation,
    t.dictionary_name,

    p.equation_symbol,
    p.perform_param_type,
    p.to_judge_by,
    p.hint_dict_key as param_hint,
    p.available_values_source,

    r.proof_req_type,
    r.proof_example_url,
    r.hint_dict_key as proof_hint
  </sql>

  <update id="mergeSideMissionType" parameterType="com.bsm.oa.sm.model.SideMissionType">
    insert into side_mission_type(sm_type_id, description_document_url, equation, dictionary_name)
    values (#{typeId.value}, #{descriptionDocumentUrl.value}, #{equation.value},
    #{dictionaryName.value})
    on conflict (sm_type_id)
    do update set
    description_document_url = #{descriptionDocumentUrl.value},
    equation = #{equation.value},
    dictionary_name = #{dictionaryName.value};

    delete from side_mission_proof_req where sm_type_id = #{typeId.value};
    delete from side_mission_perform_param where sm_type_id = #{typeId.value};

    <foreach collection="performParams" item="p">
      insert into side_mission_perform_param
      (sm_type_id, equation_symbol, perform_param_type,
      to_judge_by, hint_dict_key, available_values_source)
      values (#{typeId.value}, #{p.symbol.value}, #{p.type}, #{p.toJudgeBy}, #{p.hint.value},
      #{p.availableValuesSource});
    </foreach>

    <foreach collection="proofRequirements" item="r">
      insert into side_mission_proof_req(sm_type_id, proof_req_type, proof_example_url,
      hint_dict_key) values
      (#{typeId.value}, #{r.type}, #{r.exampleUrl.value}, #{r.hint.value});
    </foreach>

  </update>

  <select id="getSideMissionTypes" resultMap="SideMissionTypeMap">
    select
    <include refid="sideMissionTypeColumns"/>
    from side_mission_type t
    natural join side_mission_perform_param p
    natural join side_mission_proof_req r
  </select>

  <insert id="insertSideMissionReport" parameterType="com.bsm.oa.sm.request.ReportSideMissionRequest">
    insert into side_mission_report(sm_type_id, performing_user_id, reporting_user_id) values
    (#{missionTypeId.value}, #{performingUserId.value}, #{performingUserId.value});

    <foreach collection="proofMediaLinks" item="link">
      insert into side_mission_report_proof(report_id, proof_type, proof_url) values
      (currval('side_mission_report_report_id_seq'), #{link.type}, #{link.awsS3Url.value});
    </foreach>
  </insert>

</mapper>
